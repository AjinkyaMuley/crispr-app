import type { Document } from '../bson';
import type { Db } from '../db';
import { executeOperation, type ExecutionResult } from '../operations/execute_operation';
import {
  type CollectionInfo,
  ListCollectionsOperation,
  type ListCollectionsOptions
} from '../operations/list_collections';
import type { ClientSession } from '../sessions';
<<<<<<< HEAD
import type { Callback } from '../utils';
=======
<<<<<<< HEAD
import type { Callback } from '../utils';
=======
>>>>>>> 606e41d43ceed91f179614d13298418977dd016f
>>>>>>> 84c787a2e896c0e7a46e04aae83d200a1242e9bc
import { AbstractCursor } from './abstract_cursor';

/** @public */
export class ListCollectionsCursor<
  T extends Pick<CollectionInfo, 'name' | 'type'> | CollectionInfo =
    | Pick<CollectionInfo, 'name' | 'type'>
    | CollectionInfo
> extends AbstractCursor<T> {
  parent: Db;
  filter: Document;
  options?: ListCollectionsOptions;

  constructor(db: Db, filter: Document, options?: ListCollectionsOptions) {
    super(db.client, db.s.namespace, options);
    this.parent = db;
    this.filter = filter;
    this.options = options;
  }

  clone(): ListCollectionsCursor<T> {
    return new ListCollectionsCursor(this.parent, this.filter, {
      ...this.options,
      ...this.cursorOptions
    });
  }

  /** @internal */
<<<<<<< HEAD
  _initialize(session: ClientSession | undefined, callback: Callback<ExecutionResult>): void {
=======
<<<<<<< HEAD
  _initialize(session: ClientSession | undefined, callback: Callback<ExecutionResult>): void {
=======
  async _initialize(session: ClientSession | undefined): Promise<ExecutionResult> {
>>>>>>> 606e41d43ceed91f179614d13298418977dd016f
>>>>>>> 84c787a2e896c0e7a46e04aae83d200a1242e9bc
    const operation = new ListCollectionsOperation(this.parent, this.filter, {
      ...this.cursorOptions,
      ...this.options,
      session
    });

<<<<<<< HEAD
=======
<<<<<<< HEAD
>>>>>>> 84c787a2e896c0e7a46e04aae83d200a1242e9bc
    executeOperation(this.parent.client, operation, (err, response) => {
      if (err || response == null) return callback(err);

      // TODO: NODE-2882
      callback(undefined, { server: operation.server, session, response });
    });
<<<<<<< HEAD
=======
=======
    const response = await executeOperation(this.parent.client, operation);

    // TODO: NODE-2882
    return { server: operation.server, session, response };
>>>>>>> 606e41d43ceed91f179614d13298418977dd016f
>>>>>>> 84c787a2e896c0e7a46e04aae83d200a1242e9bc
  }
}
